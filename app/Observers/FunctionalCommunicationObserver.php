<?php

namespace App\Observers;

use App\Models\Domain;
use App\Models\Subdomain;
use App\Models\Area;
use App\Models\Activity;
use App\Models\Task;
use App\Models\Mitp;
use App\Models\FunctionalCommunication;

class FunctionalCommunicationObserver
{
    /**
     * Handle the FunctionalCommunication "created" event.
     *
     * @param FunctionalCommunication $FunctionalCommunication
     *
     * @return void
     */
    public function created(FunctionalCommunication $FunctionalCommunication): void
    {   
        $attrs = \Schema::getColumnListing((new FunctionalCommunication)->getTable());
        foreach($attrs as $attr){
            if($FunctionalCommunication->$attr == NULL){
                $FunctionalCommunication->$attr = request()->$attr;  
                $FunctionalCommunication->saveQuietly();  
                
                if(request()->$attr != 'no' && request()->$attr != null){//dd(request()->$attr);
                    if(Domain::where('title', request()->$attr)->exists()){ 
                      $domain = Domain::where('title', request()->$attr)->first();  
                      foreach(Subdomain::where('domain_id', $domain->id)->get() as $subdomain){
                        foreach(Area::where('subdomain_id', $subdomain->id)->get() as $area){
                            $activities = Activity::where('area_id', $area->id)->get();
                            foreach($activities as $activity){
                                if(Activity::find($activity->id) != null){
                                    $tasks = Task::where('activity_id', $activity->id)->get(); 
                                    foreach($tasks as $task){
                                        Mitp::create([
                                                'student_id' => request()->student_id,
                                                'activity_id' => $activity->id,
                                                'task_id' => $task->id,
                                                'functional_communication_id'=>  $FunctionalCommunication->id 
                                        ]);
                                    }
                                }
                            }
                        }
                      }
                    }
                    elseif(Subdomain::where('title', request()->$attr)->exists()){
                       $subdomain = Subdomain::where('title', request()->$attr)->first();
                       foreach(Area::where('subdomain_id', $subdomain->id)->get() as $area){
                            $activities = Activity::where('area_id', $area->id)->get();
                            foreach($activities as $activity){
                                if(Activity::find($activity->id) != null){
                                    $tasks = Task::where('activity_id', $activity->id)->get(); 
                                    foreach($tasks as $task){
                                        Mitp::create([
                                                'student_id' => request()->student_id,
                                                'activity_id' => $activity->id,
                                                'task_id' => $task->id,
                                                'functional_communication_id'=>  $FunctionalCommunication->id
                                        ]);
                                    }
                                }
                            }
                        }
                    }    
                    elseif(Area::where('title', request()->$attr)->exists()){
                        $area = Area::where('title', request()->$attr)->first();
                        $activities = Activity::where('area_id', $area->id)->get();
                        foreach($activities as $activity){
                        if(Activity::find($activity->id) != null){
                            $tasks = Task::where('activity_id', $activity->id)->get(); 
                                foreach($tasks as $task){
                                    Mitp::create([
                                        'student_id' => request()->student_id,
                                        'activity_id' => $activity->id,
                                        'task_id' => $task->id,
                                        'functional_communication_id'=>  $FunctionalCommunication->id 
                                    ]);
                                }
                            }
                        }
                    }
                    else{ 
                        $activity = Activity::where('title', request()->$attr)->first(); 
                        if($activity != null){
                            $tasks = Task::where('activity_id', $activity->id)->get(); 
                            foreach($tasks as $task){
                                Mitp::create([
                                    'student_id' => request()->student_id,
                                    'activity_id' => $activity->id,
                                    'task_id' => $task->id,
                                    'functional_communication_id'=>  $FunctionalCommunication->id 
                                ]);
                            }
                        }
                    }    
                }
            }    
        }
    }
    /**
     * Handle the FunctionalCommunication "updated" event.
     *
     * @param FunctionalCommunication $FunctionalCommunication
     *
     * @return void
     */
    public function updated(FunctionalCommunication $FunctionalCommunication): void {  //dd(request());
      Mitp::where('functional_communication_id', $FunctionalCommunication->id)->delete();    
      $attrs = \Schema::getColumnListing((new FunctionalCommunication)->getTable());
      foreach($attrs as $attr){ 
           $data_type = collect(\DB::select("SELECT DATA_TYPE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = 'nov' AND TABLE_NAME = 'functional_communications' AND COLUMN_NAME = '$attr'"))->first()->DATA_TYPE;
         
           if($data_type == 'text'){ 
            $FunctionalCommunication->$attr = request()->$attr;  
            $FunctionalCommunication->saveQuietly();  //dd(request()->$attr);
            if(request()->$attr != 'no' && request()->$attr != null){ 
                if(Domain::where('title', request()->$attr)->exists()){ 
                  $domain = Domain::where('title', request()->$attr)->first();  
                  foreach(Subdomain::where('domain_id', $domain->id)->get() as $subdomain){
                    foreach(Area::where('subdomain_id', $subdomain->id)->get() as $area){
                        $activities = Activity::where('area_id', $area->id)->get();
                        foreach($activities as $activity){
                            if(Activity::find($activity->id) != null){
                                $tasks = Task::where('activity_id', $activity->id)->get(); 
                                foreach($tasks as $task){
                                    $check = Mitp::where([ 'student_id' => request()->student_id,
                                    'activity_id' => $activity->id,
                                    'task_id' => $task->id,
                                    'functional_communication_id'=>  $FunctionalCommunication->id ])->exists(); 
                                    if($check==false){ 
                                        Mitp::create([
                                            'student_id' => request()->student_id,
                                            'activity_id' => $activity->id,
                                            'task_id' => $task->id,
                                            'functional_communication_id'=>  $FunctionalCommunication->id 
                                        ]);
                                    }
                                }
                            }
                        }
                    }
                  }
                }
                elseif(Subdomain::where('title', request()->$attr)->exists()){
                   $subdomain = Subdomain::where('title', request()->$attr)->first();
                   foreach(Area::where('subdomain_id', $subdomain->id)->get() as $area){
                        $activities = Activity::where('area_id', $area->id)->get();
                        foreach($activities as $activity){
                            if(Activity::find($activity->id) != null){
                                $tasks = Task::where('activity_id', $activity->id)->get(); 
                                foreach($tasks as $task){
                                    $check = Mitp::where([ 'student_id' => request()->student_id,
                                    'activity_id' => $activity->id,
                                    'task_id' => $task->id,
                                    'functional_communication_id'=>  $FunctionalCommunication->id ])->exists(); 
                                    if($check==false){ 
                                        Mitp::create([
                                            'student_id' => request()->student_id,
                                            'activity_id' => $activity->id,
                                            'task_id' => $task->id,
                                            'functional_communication_id'=>  $FunctionalCommunication->id 
                                        ]);
                                    }
                                }
                            }
                        }
                    }
                }    
                elseif(Area::where('title', request()->$attr)->exists()){
                    $area = Area::where('title', request()->$attr)->first();
                    $activities = Activity::where('area_id', $area->id)->get();
                    foreach($activities as $activity){
                    if(Activity::find($activity->id) != null){
                        $tasks = Task::where('activity_id', $activity->id)->get(); 
                            foreach($tasks as $task){
                                $check = Mitp::where([ 'student_id' => request()->student_id,
                                'activity_id' => $activity->id,
                                'task_id' => $task->id,
                                'functional_communication_id'=>  $FunctionalCommunication->id ])->exists(); 
                                if($check==false){ 
                                    Mitp::create([
                                        'student_id' => request()->student_id,
                                        'activity_id' => $activity->id,
                                        'task_id' => $task->id,
                                        'functional_communication_id'=>  $FunctionalCommunication->id 
                                    ]);
                                }
                            }
                        }
                    }
                }
                else{ 
                    $activity = Activity::where('title', request()->$attr)->first(); 
                    if($activity != null){
                        $tasks = Task::where('activity_id', $activity->id)->get(); 
                        foreach($tasks as $task){
                            $check = Mitp::where([ 'student_id' => request()->student_id,
                            'activity_id' => $activity->id,
                            'task_id' => $task->id,
                            'functional_communication_id'=>  $FunctionalCommunication->id ])->exists(); 
                            if($check==false){ 
                                Mitp::create([
                                    'student_id' => request()->student_id,
                                    'activity_id' => $activity->id,
                                    'task_id' => $task->id,
                                    'functional_communication_id'=>  $FunctionalCommunication->id 
                                ]);
                            }
                        }
                    }
                }    
            }
          }
            
      }   
    }  
}
